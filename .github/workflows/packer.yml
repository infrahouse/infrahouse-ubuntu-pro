---
name: 'Packer AMI build'

on:  # yamllint disable-line rule:truthy
  pull_request:


permissions:
  id-token: write  # This is required for requesting the JWT
  contents: read
  pull-requests: write

env:
  AWS_REGION: "us-west-1"

  UBUNTU_CODENAME: "noble"
  ROLE_ARN: "arn:aws:iam::303467602807:role/ih-tf-infrahouse-ubuntu-pro-github"
jobs:
  build:
    name: 'Build AMI'
    runs-on: ["self-hosted", "Linux", "noble"]

    defaults:
      run:
        shell: bash

    steps:
      # Checkout the repository to the GitHub Actions runner
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN}}
          role-session-name: packer-build
          aws-region: ${{ env.AWS_REGION }}

      - name: Packer init
        run: packer init .

      - name: Packer build
        run: |
          PARAMS=$(aws ssm get-parameter --name /infrahouse/ubuntu-pro/args)
          ssh_private_key_file="$(mktemp)"
          echo $PARAMS | jq.ssh_private_key > "$ssh_private_key_file"
          packer build \
            -var "region=$(echo $PARAMS | jq.region)" \
            -var "ssh_keypair_name=$(echo $PARAMS | jq.ssh_keypair_name)" \
            -var "ssh_keypair_name=$(echo $PARAMS | jq.ssh_keypair_name)" \
            -var "security_group_id=$(echo $PARAMS | jq .security_group_id)" \
            -var "subnet_id=$(echo $PARAMS | jq.subnet_id)" \
            -var "ssh_private_key_file=$ssh_private_key_file" \
            -var "ubuntu_codename=${{ env.UBUNTU_CODENAME }}" \
            .
          rm -f "$ssh_private_key_file"
